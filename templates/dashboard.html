<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Session Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">VR Session Data</h1>
            <p class="text-gray-600">Download your session records</p>
        </div>



        <!-- Health Check Section -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Database Health</h3>
                    <button onclick="checkHealth()" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">Check Health</button>
                </div>
            </div>
            <div class="px-6 py-4">
                <div id="healthStatus" class="text-sm text-gray-600">Click "Check Health" to test database connection</div>
                <div id="healthDetails" class="mt-2 hidden">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium">Status:</span>
                            <span id="dbStatus" class="ml-2"></span>
                        </div>
                        <div>
                            <span class="font-medium">Database:</span>
                            <span id="dbConnection" class="ml-2"></span>
                        </div>
                        <div>
                            <span class="font-medium">Total Records:</span>
                            <span id="totalRecords" class="ml-2"></span>
                        </div>
                        <div>
                            <span class="font-medium">Total Sessions:</span>
                            <span id="totalSessions" class="ml-2"></span>
                        </div>
                    </div>
                    <div id="healthError" class="mt-2 text-red-600 hidden"></div>
                </div>
            </div>
        </div>

        <!-- Records List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Session Records</h3>
                    <button onclick="refreshSessions()" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Refresh</button>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span id="sessionCount" class="text-sm text-gray-600">Loading...</span>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="searchInput" placeholder="Search session ID..." class="px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="searchSessions()" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">Search</button>
                        </div>
                        <div class="flex space-x-2">
                            <button id="prevPage" onclick="previousPage()" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                            <span id="pageInfo" class="px-3 py-1 text-sm text-gray-600">Page 1</span>
                            <button id="nextPage" onclick="nextPage()" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Records</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="sessionsTable">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables for pagination
        let currentPage = 0;
        let pageSize = 20;
        let totalSessions = 0;
        let isSearchMode = false;
        let searchQuery = '';
        
        // Search functionality
        const searchInput = document.getElementById('searchInput');

        // Safe date formatting function
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            try {
                // Handle ISO format with Z suffix
                if (typeof dateString === 'string' && dateString.includes('T')) {
                    const date = new Date(dateString);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleString();
                    }
                }
                
                // Handle other string formats
                if (typeof dateString === 'string') {
                    const date = new Date(dateString);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleString();
                    }
                }
                
                // Handle Date objects
                if (dateString instanceof Date) {
                    return dateString.toLocaleString();
                }
                
                // Fallback: convert to string
                return String(dateString);
            } catch (error) {
                console.warn('Error formatting date:', dateString, error);
                return String(dateString);
            }
        }

        // Add enter key support for search
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchSessions();
            }
        });

        // Clear search when input is cleared
        searchInput.addEventListener('input', (e) => {
            if (e.target.value === '') {
                clearSearch();
            }
        });



        // Load sessions data using the unified sessions endpoint
        async function loadSessions() {
            try {
                const response = await fetch(`/api/sessions?limit=${pageSize}&offset=${currentPage * pageSize}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Check if there was an error in the response
                if (data.error) {
                    console.warn('Sessions endpoint error:', data.error);
                    document.getElementById('sessionCount').textContent = 'Error loading sessions';
                    return;
                }
                
                const tbody = document.getElementById('sessionsTable');
                tbody.innerHTML = '';
                
                // Update session count
                totalSessions = data.total;
                document.getElementById('sessionCount').textContent = `Total Sessions: ${totalSessions}`;
                
                // Update pagination info
                updatePaginationInfo();
                
                // Render sessions
                data.items.forEach(session => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${session.session_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.records}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(session.created)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button onclick="downloadSession('${session.session_id}')" class="text-blue-600 hover:text-blue-900">Download</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update pagination buttons
                updatePaginationButtons();
                
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessionCount').textContent = 'Error loading sessions';
            }
        }



        // Pagination functions
        function updatePaginationInfo() {
            const startRecord = currentPage * pageSize + 1;
            const endRecord = Math.min((currentPage + 1) * pageSize, totalSessions);
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} (${startRecord}-${endRecord} of ${totalSessions})`;
        }

        function updatePaginationButtons() {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = (currentPage + 1) * pageSize >= totalSessions;
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                loadSessions();
            }
        }

        function nextPage() {
            if ((currentPage + 1) * pageSize < totalSessions) {
                currentPage++;
                loadSessions();
            }
        }

        // Download session data
        async function downloadSession(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/download`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session_${sessionId}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Download failed: ' + error.message);
            }
        }

        // Refresh sessions button
        function refreshSessions() {
            currentPage = 0; // Reset to first page on refresh
            loadSessions();
        }

        // Health check function
        async function checkHealth() {
            const healthStatus = document.getElementById('healthStatus');
            const healthDetails = document.getElementById('healthDetails');
            const healthError = document.getElementById('healthError');
            
            healthStatus.textContent = 'Checking database health...';
            healthDetails.classList.add('hidden');
            healthError.classList.add('hidden');
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    healthStatus.textContent = '✅ Database is healthy and connected';
                    healthStatus.className = 'text-sm text-green-600 font-medium';
                    
                    // Show details
                    document.getElementById('dbStatus').textContent = data.status;
                    document.getElementById('dbConnection').textContent = data.database;
                    document.getElementById('totalRecords').textContent = data.total_records;
                    document.getElementById('totalSessions').textContent = data.total_sessions;
                    
                    healthDetails.classList.remove('hidden');
                } else {
                    healthStatus.textContent = '❌ Database health check failed';
                    healthStatus.className = 'text-sm text-red-600 font-medium';
                    
                    healthError.textContent = data.error || 'Unknown error occurred';
                    healthError.classList.remove('hidden');
                }
            } catch (error) {
                healthStatus.textContent = '❌ Failed to check database health';
                healthStatus.className = 'text-sm text-red-600 font-medium';
                
                healthError.textContent = `Network error: ${error.message}`;
                healthError.classList.remove('hidden');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
            // Auto-check health on page load
            checkHealth();
        });
    </script>
</body>
</html>
